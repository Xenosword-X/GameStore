import{r as b,D as L,y as T,c as d,o as r,a as t,j as S,t as l,F as x,k as M,z as V,d as $,f as F,h as w,s as h,n as N,g as D}from"./index-Drcz_wGL.js";import{a as I,_ as P}from"./Pagination-yifaCfQs.js";const j={class:"modal-dialog modal-xl",role:"document"},q={class:"modal-content border-0"},z={class:"modal-body"},U={class:"row"},A={class:"col-md-4"},G={key:0,class:"table"},H={class:"col-md-8"},J={class:"table"},K={key:0},Q={key:1},R={key:0,class:"text-success"},W={key:1,class:"text-muted"},X={class:"table"},Y={class:"text-end"},Z={__name:"OrderModal",props:{order:{type:Object,default:()=>({})}},setup(C,{expose:m}){const _=C,c=b(null),s=b({}),{showModal:f,hideModal:y}=L(c);T(()=>_.order,u=>{s.value={...u}},{immediate:!0});const g=u=>{const e=Number(u);return!e||isNaN(e)?"無效時間":new Date(e*1e3).toISOString().split("T")[0]};return m({showModal:f,hideModal:y}),(u,e)=>(r(),d("div",{class:"modal fade",tabindex:"-1","aria-hidden":"true",ref_key:"modal",ref:c},[t("div",j,[t("div",q,[e[12]||(e[12]=t("div",{class:"modal-header bg-dark text-white"},[t("h5",{class:"modal-title"},[t("span",null,"訂單細節")]),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1)),t("div",z,[t("div",U,[t("div",A,[e[4]||(e[4]=t("h3",null,"用戶資料",-1)),s.value.user?(r(),d("table",G,[t("tbody",null,[t("tr",null,[e[0]||(e[0]=t("th",{style:{width:"100px"}},"姓名",-1)),t("td",null,l(s.value.user.name),1)]),t("tr",null,[e[1]||(e[1]=t("th",null,"Email",-1)),t("td",null,l(s.value.user.email),1)]),t("tr",null,[e[2]||(e[2]=t("th",null,"電話",-1)),t("td",null,l(s.value.user.tel),1)]),t("tr",null,[e[3]||(e[3]=t("th",null,"地址",-1)),t("td",null,l(s.value.user.address),1)])])])):S("",!0)]),t("div",H,[e[10]||(e[10]=t("h3",null,"訂單細節",-1)),t("table",J,[t("tbody",null,[t("tr",null,[e[5]||(e[5]=t("th",{style:{width:"100px"}},"訂單編號",-1)),t("td",null,l(s.value.id),1)]),t("tr",null,[e[6]||(e[6]=t("th",null,"下單時間",-1)),t("td",null,l(g(s.value.create_at)),1)]),t("tr",null,[e[7]||(e[7]=t("th",null,"付款時間",-1)),t("td",null,[s.value.paid_date?(r(),d("span",K,l(g(s.value.paid_date)),1)):(r(),d("span",Q,"時間不正確"))])]),t("tr",null,[e[8]||(e[8]=t("th",null,"付款狀態",-1)),t("td",null,[s.value.is_paid?(r(),d("strong",R,"已付款")):(r(),d("span",W,"尚未付款"))])]),t("tr",null,[e[9]||(e[9]=t("th",null,"總金額",-1)),t("td",null,l(u.$filters.currency(s.value.total)),1)])])]),e[11]||(e[11]=t("h3",null,"選購商品",-1)),t("table",X,[t("tbody",null,[(r(!0),d(x,null,M(s.value.products,v=>(r(),d("tr",{key:v.id},[t("th",null,l(v.product.title),1),t("td",null,l(v.qty)+" / "+l(v.product.unit),1),t("td",Y,l(u.$filters.currency(v.final_total)),1)]))),128))])])])])]),e[13]||(e[13]=t("div",{class:"modal-footer"},[t("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 關閉 ")],-1))])])],512))}},tt={class:"table-responsive"},et={class:"table table-hover align-middle text-nowrap"},st={key:0},lt={class:"list-unstyled mb-0"},at={class:"text-end"},ot={class:"text-center"},nt={class:"d-flex flex-column align-items-center"},dt={class:"form-check form-switch"},rt=["id","checked","disabled","onChange"],it={class:"text-center"},ut={class:"btn-group"},ct=["onClick"],pt=["onClick"],_t={__name:"Orders",setup(C){const m=b([]),_=b({}),c=b(!1),s=b({}),f=b(null),y=b(null),g=o=>{const a=Number(o);return Number.isFinite(a)?new Date(a*1e3).toISOString().split("T")[0]:"日期格式錯誤"},u=async(o=1)=>{const a=`https://vue3-course-api.hexschool.io/v2/api/xenosword-api/admin/orders?page=${o}`;c.value=!0;try{const i=await w.get(a);i.data.success?(m.value=i.data.orders,_.value=i.data.pagination):h("error",i.data.message||"訂單載入失敗")}catch(i){console.error("訂單載入錯誤",i),h("error","訂單載入失敗")}finally{c.value=!1}},e=o=>{s.value={...o},f.value.showModal()},v=o=>{s.value={...o},y.value.showModal()},O=async(o,a)=>{const i=typeof a=="boolean"?a:!!o.is_paid,n=!!o.is_paid,k=`https://vue3-course-api.hexschool.io/v2/api/xenosword-api/admin/order/${o.id}`;c.value=!0;try{await w.put(k,{data:{is_paid:i}}),o.is_paid=i?1:0,h("success","付款狀態已更新"),await u(_.value?.current_page||1)}catch(p){console.error("更新付款狀態失敗",p),o.is_paid=n?1:0,h("error","付款狀態更新失敗")}finally{c.value=!1}},B=async()=>{const o=`https://vue3-course-api.hexschool.io/v2/api/xenosword-api/admin/order/${s.value.id}`;try{await w.delete(o),y.value.hideModal(),h("success","訂單已刪除"),await u(_.value?.current_page||1)}catch(a){console.error("刪除訂單失敗",a),h("error","訂單刪除失敗")}};return V(u),(o,a)=>{const i=F("Loading");return r(),d(x,null,[$(i,{active:c.value},null,8,["active"]),a[3]||(a[3]=t("h2",{class:"h4 fw-bold mt-4 mb-3"},"訂單管理",-1)),t("div",tt,[t("table",et,[a[2]||(a[2]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"購買日期"),t("th",null,"Email"),t("th",null,"購買品項"),t("th",{class:"text-end"},"金額"),t("th",{class:"text-center"},"付款狀態"),t("th",{class:"text-center"},"操作")])],-1)),m.value.length?(r(),d("tbody",st,[(r(!0),d(x,null,M(m.value,(n,k)=>(r(),d("tr",{key:k,class:N({"text-muted":!n.is_paid})},[t("td",null,l(g(n.create_at)),1),t("td",null,l(n.user?.email||"未填寫"),1),t("td",null,[t("ul",lt,[(r(!0),d(x,null,M(n.products,(p,E)=>(r(),d("li",{key:E},l(p.product.title)+" × "+l(p.qty)+" "+l(p.product.unit),1))),128))])]),t("td",at,l(o.$filters.currency(n.total)),1),t("td",ot,[t("div",nt,[t("span",{class:N(["badge mb-1",n.is_paid?"bg-success":"bg-secondary"])},l(n.is_paid?"已付款":"未付款"),3),t("div",dt,[t("input",{class:"form-check-input",type:"checkbox",id:`paidSwitch${n.id}`,checked:!!n.is_paid,disabled:c.value,onChange:p=>O(n,p.target.checked)},null,40,rt)])])]),t("td",it,[t("div",ut,[t("button",{class:"btn btn-outline-primary btn-sm",onClick:p=>e(n)},[...a[0]||(a[0]=[t("i",{class:"bi bi-eye"},null,-1),D(" 檢視 ",-1)])],8,ct),t("button",{class:"btn btn-outline-danger btn-sm",onClick:p=>v(n)},[...a[1]||(a[1]=[t("i",{class:"bi bi-trash"},null,-1),D(" 刪除 ",-1)])],8,pt)])])],2))),128))])):S("",!0)])]),$(Z,{ref_key:"orderModal",ref:f,order:s.value,onUpdatePaid:O},null,8,["order"]),$(I,{ref_key:"delModal",ref:y,item:s.value,onDelItem:B},null,8,["item"]),$(P,{pages:_.value,onEmitPages:u},null,8,["pages"])],64)}}};export{_t as default};
